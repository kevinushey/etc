#!/usr/bin/env bash
# shellcheck disable=SC2086

# Initialization ----
TMUX_VERSION="$(tmux -V | cut -d" " -f2)"
TMUX_CONFIG_SOURCE="$(cd "$(dirname "$0")"; pwd -P)/tmux-config"

# Configuration ----
: ${TMUX_CONFIG_PATH="${HOME}/.tmux/bin/tmux-config"}
: ${TMUX_CONFIG_INPUT="${HOME}/.tmux/.tmux.conf"}
: ${TMUX_CONFIG_OUTPUT="${HOME}/.tmux/config/$(uname)-${TMUX_VERSION}/.tmux.conf"}

# Bootstrapping ----

if [ "$1" = "--bootstrap" ]; then

	read -r -d '' LOADER <<- EOF
	# Generated by tmux-config. Please edit the file at '${TMUX_CONFIG_INPUT/$HOME/\~}'.
	run-shell "${TMUX_CONFIG_PATH/$HOME/\~}"
	EOF

	# copy the tmux configuration script to requested path
	mkdir -p "$(dirname "${TMUX_CONFIG_PATH}")"
	cp "${TMUX_CONFIG_SOURCE}" "${TMUX_CONFIG_PATH}" || {
		echo "Failed to copy tmux-config to '${TMUX_CONFIG_PATH}'"
		exit 1
	}

	# if it looks like we've never added an autoloader, this is likely the
	# user's own '.tmux.conf' file
	if ! grep -siq "# Generated by tmux-config" ~/.tmux.conf; then
		mkdir -p "$(dirname "${TMUX_CONFIG_INPUT}")"
		cp ~/.tmux.conf "${TMUX_CONFIG_INPUT}"
	fi

	# update the autoloader
	echo "${LOADER}" > ~/.tmux.conf

	echo "'tmux-config' successfully bootstrapped."

	if [ -n "${TMUX}" ]; then
		echo "Restart your tmux session to enable 'tmux-config'."
	fi

	exit 0

fi

# Global State ----

# The document, represented as an array of strings.
DOCUMENT=()

# A 'stack', representing the results of evaluating 'if' statements
# discovered within the tmux configuration generator. Values will be
# either 'y' or 'n'. We start in the 'y'es state.
STACK="y"

process-line () {

	# if we have no configuration directive, then just write
	# the line out as-is (when enabled)
	if ! [[ "${LINE}" =~ \ *\#+\ *@ ]]; then
		case "${STACK}" in
			*n*) ;;
			*y) DOCUMENT+=("${LINE}") ;;
		esac
		return 0
	fi

	# extract the configuration directive
	local DIRECTIVE
	DIRECTIVE="${LINE/*\#*\@/}"

	case "${DIRECTIVE}" in

	# 'source': source a file
	"source"*)
		local STATEMENT="${DIRECTIVE/source /}"
		eval ". ${STATEMENT}"
	;;

	# 'eval': evaluate in current shell
	"eval"*)
		local STATEMENT="${DIRECTIVE/eval /}"
		eval "${STATEMENT}"
	;;

	# 'if': evaluate and check return result
	"if"*)
		local STATEMENT="${DIRECTIVE/if /}"
		eval "${STATEMENT}" &> /dev/null && STACK="${STACK}y" || STACK="${STACK}n"
	;;

	# 'elif': evaluate and check return result
	"elif"*)
		local STATEMENT="${DIRECTIVE/elif /}"
		eval "${STATEMENT}" &> /dev/null && STACK="${STACK%?}y" || STACK="${STACK%?n}"
	;;

	# 'else': flip state
	"else"*)
		case "${STACK}" in
		*y) STACK="${STACK%?}n" ;;
		*n) STACK="${STACK%?}y" ;;
		esac
	;;

	# 'fi': pop the stack
	"fi"*)
		[ -z "${STACK}" ] && echo "[$I]: unexpected 'fi'"
		STACK="${STACK%?}"
	;;

	# unrecognized directive
	*)
		echo "[$I]: unrecognized directive '${DIRECTIVE}'"
	esac
}

if [ "${TMUX_CONFIG_INPUT}" -nt "${TMUX_CONFIG_OUTPUT}" ]; then
	declare -i I=1
	while IFS="" read -r LINE; do
		process-line "${LINE}" "${I}"
		I+=1
	done < "${TMUX_CONFIG_INPUT}"
	mkdir -p "$(dirname "${TMUX_CONFIG_OUTPUT}")"
	printf "%s\n" "${DOCUMENT[@]}" > "${TMUX_CONFIG_OUTPUT}"
fi

# ask tmux to source the generated file
tmux source-file "${TMUX_CONFIG_OUTPUT}"

